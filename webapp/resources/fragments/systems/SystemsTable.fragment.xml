<core:FragmentDefinition xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:tnt="sap.tnt"
    core:require="{ formatMessage: 'sap/base/strings/formatMessage', commonFormatter: 'kms/common/Formatters' }">
    <HBox width="100%"
        justifyContent="End">
        <tnt:InfoLabel
            visible="{= !${oneWay>/keyConfig/canConnectSystems} &amp;&amp; !${oneWay>/isSytemsView}}"
            icon="sap-icon://warning"
            text="{i18n>connectSystemDisabledTooltip}"
            renderMode="Narrow"
            colorScheme="1" />
    </HBox>
    <Table
        id="systemsTable"
        inset="false"
        items="{oneWay>/systems}"
        busy="{oneWay>/systemsTableUpdating}">
        <headerToolbar>
            <OverflowToolbar>
                <Title
                    text="{parts: ['i18n>systemsCount', 'oneWay>/systemsCount'], formatter: 'formatMessage'}"
                    level="H2" />
                <ToolbarSpacer />
                <Button text="{i18n>connect}" icon="sap-icon://add"
                    enabled="{= ${oneWay>/keyConfig/canConnectSystems}}"
                    press="onConnectSystemPress"
                    visible="{= !!${oneWay>/keyConfigDetail} &amp;&amp; ${roleBasedAccess>/keyConfig/canManage}}">
                    <customData>
                        <core:CustomData
                            key="testId"
                            value="systemsTable-connectButton"
                            writeToDom="true" />
                    </customData>
                </Button>
                <Button
                        icon="sap-icon://refresh"
                        type="Transparent"
                        press="updateSystemsTable">
                    <customData>
                        <core:CustomData
                                key="testId"
                                value="systemsTable-refreshButton"
                                writeToDom="true" />
                    </customData>
                </Button>
                <Button
                    icon="sap-icon://filter"
                    press="onKeysTableFilterPress"
                    visible="{= !!${oneWay>/keyConfigDetail}}"
                    type="Transparent">
                    <customData>
                        <core:CustomData
                            key="testId"
                            value="keysTable-filterButton"
                            writeToDom="true" />
                    </customData>
                </Button>
                <Button
                    icon="sap-icon://sort"
                    press="onKeysTableSortPress"
                    visible="{= !!${oneWay>/keyConfigDetail}}"
                    class="sapUiSmallMarginEnd"
                    type="Transparent">
                    <customData>
                        <core:CustomData
                            key="testId"
                            value="keysTable-sortButton"
                            writeToDom="true" />
                    </customData>
                </Button>
            </OverflowToolbar>
        </headerToolbar>

        <columns>
            <Column minScreenWidth="Tablet" demandPopin="true">
                <Text text="{i18n>name}" />
            </Column>
            <Column minScreenWidth="Tablet" demandPopin="true">
                <Text text="{i18n>identifier}" />
            </Column>
            <Column minScreenWidth="Tablet" demandPopin="true">
                <Text text="{i18n>type}" />
            </Column>
            <Column minScreenWidth="Tablet" demandPopin="true">
                <Text text="{i18n>systemsRole}" />
            </Column>
            <Column minScreenWidth="Tablet" demandPopin="true">
                <Text
                    text="{= !!${oneWay>/keyConfigDetail} ? ${i18n>state} : ${i18n>keyConfiguration}}" />
            </Column>
            <Column minScreenWidth="Tablet" demandPopin="true"
                visible="{= ${roleBasedAccess>/keyConfig/canManage} &amp;&amp; !!${oneWay>/keyConfigDetail}}"
                hAlign="End"
                vAlign="Middle">
                <Text text="{i18n>actions}" />
            </Column>
        </columns>

        <items>
            <ColumnListItem vAlign="Middle" type="Navigation" press="onSystemPress">
                <cells>
                    <ObjectIdentifier title="{oneWay>properties/externalName}"
                        text="{oneWay>region}">
                        <customData>
                            <core:CustomData
                                key="testId"
                                value="systemsTable-nameObjectIdentifier"
                                writeToDom="true" />
                        </customData>
                    </ObjectIdentifier>
                    <Text text="{oneWay>identifier}">
                        <customData>
                            <core:CustomData
                                key="testId"
                                value="systemsTable-idText"
                                writeToDom="true" />
                        </customData>
                    </Text>
                    <Text
                        text="{parts: ['oneWay>type'], formatter: 'commonFormatter.setSystemType'}">
                        <customData>
                            <core:CustomData
                                key="testId"
                                value="systemsTable-typeText"
                                writeToDom="true" />
                        </customData>
                    </Text>
                    <Text
                        text="{parts: ['oneWay>properties/roleName', 'oneWay>properties/roleID'], formatter: 'commonFormatter.setSystemRole'}">
                        <customData>
                            <core:CustomData
                                key="testId"
                                value="systemsTable-roleText"
                                writeToDom="true" />
                        </customData>
                    </Text>
                    <VBox>
                        <ObjectStatus
                            icon="{parts: ['oneWay>status'], formatter: 'commonFormatter.setSystemStatusIcon'}"
                            text="{parts: ['oneWay>status'], formatter: '.getText'}"
                            active="true"
                            press="handleStatusPressed"
                            visible="{= ${oneWay>status} !== 'DISCONNECTED'}"
                            inverted="true"
                            state="{parts: ['oneWay>status'], formatter: 'commonFormatter.setSystemStatusColor'}">
                            <customData>
                                <core:CustomData
                                    key="testId"
                                    value="systemsTable-connectedObjectStatus"
                                    writeToDom="true" />
                            </customData>
                        </ObjectStatus>
                        <Button text="{i18n>connect}"
                            press="onTargetConnectSystemPress"
                            enabled="{= ${roleBasedAccess>/systems/canManage} }"
                            visible="{= ${oneWay>status} === 'DISCONNECTED'}"
                            icon="sap-icon://add">
                            <customData>
                                <core:CustomData
                                    key="testId"
                                    value="systemsTable-connectButton"
                                    writeToDom="true" />
                            </customData>
                        </Button>
                    </VBox>

                    <VBox alignContent="Center"
                        justifyContent="Start"
                        visible="{= ${roleBasedAccess>/keyConfig/canManage} }">
                        <MenuButton icon="sap-icon://action-settings" type="Transparent"
                            visible="{= ${oneWay>status} !== 'FAILED'}">
                            <menu>
                                <Menu class="sapUiSizeCompact">
                                    <!-- @Todo TEMP: Revert after demo -->
                                    <!-- <MenuItem text="{i18n>switchKeyConfiguration}"
                                        press="onSwitchKeyConfigPress">
                                        <customData>
                                            <core:CustomData
                                                key="testId"
                                                value="systemsTable-switchKeyConfigMenuItem"
                                                writeToDom="true" />
                                        </customData>
                                    </MenuItem> -->
                                    <MenuItem
                                        press="onSystemsTableDisconnectPress"
                                        visible="{= !!${oneWay>keyConfigurationID} &amp;&amp; ${oneWay>status} !== 'FAILED'}"
                                        text="{i18n>disconnect}">
                                        <customData>
                                            <core:CustomData
                                                key="testId"
                                                value="systemsTable-disconnectMenuItem"
                                                writeToDom="true" />
                                        </customData>
                                    </MenuItem>
                                </Menu>
                            </menu>
                            <customData>
                                <core:CustomData
                                    key="testId"
                                    value="systemsTable-actionsMenuButton"
                                    writeToDom="true" />
                            </customData>
                        </MenuButton>
                    </VBox>
                </cells>
            </ColumnListItem>
        </items>
    </Table>
</core:FragmentDefinition>